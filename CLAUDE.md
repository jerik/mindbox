# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Mindbox is a plain-text journal toolkit that extracts "mindbox" knowledge snippets from a journal file and makes them browsable in Vim as help-style buffers.

## Key Commands

**Generate mindbox files from journal:**
```sh
python3 scripts/generate_mindboxes.py                    # uses journal.txt and outputs to mindboxes/
python3 scripts/generate_mindboxes.py /path/journal.txt --output /path/mindboxes
```

## Architecture

### Journal Entry Format
Entries in `journal.txt` follow this pattern:
```
# YYYY-MM-DD HHMM [mindbox:<topic>] [optional title]
Body text here...
```

The `mindbox:<topic>` marker designates an entry for extraction. Multiple entries with the same topic are aggregated into a single `.mb` file.

### Components

- **`scripts/generate_mindboxes.py`** - Python script that parses `journal.txt`, extracts entries with `mindbox:<topic>` markers, and writes `.mb` files to the output directory. Topics are slugified (lowercased, special chars replaced with hyphens).

- **`plugin/mindbox.vim`** - Vim plugin providing:
  - `:MindboxList` - lists all topics
  - `:Mindbox <topic>` - opens topic in a help-style buffer
  - `:MindboxSearch <pattern>` - vimgrep across all topics

  Default mindbox directory is `<repo>/mindboxes`. Override with `g:mindbox_directory`.

- **`mindboxes/`** - Generated `.mb` files (one per topic). These are regenerated by the Python script.

### Data Flow
```
journal.txt → generate_mindboxes.py → mindboxes/*.mb → Vim plugin
```

### Tooling
python verwenden
uv verwenden
git verwenden

## Purpose
mindbox is a plain-text journal workflow:
1) `journal.txt` contains entries, including lines like `mindbox:<topic>`
2) `scripts/generate_mindboxes.py` extracts topics into `mindboxes/<topic>.mb`
3) the Vim plugin exposes commands to browse/search those mindboxes from Vim. :contentReference[oaicite:1]{index=1}

## Repo layout (expected)
- `journal.txt` — source journal (plain text)
- `scripts/generate_mindboxes.py` — generator (Python)
- `mindboxes/` — generated `.mb` files (treated as build artifacts)
- `plugin/mindbox.vim` — Vimscript plugin entrypoint. :contentReference[oaicite:2]{index=2}

## Non-goals
- No network calls.
- Keep everything text-based and cross-platform.

---

## Development workflow

### Neues Feature starten

1. **User** erstellt `USER-STORY.md` mit Feature-Beschreibung
2. **User + Claude** verfeinern `USER-STORY.md` im Dialog
   - Anforderungen klären
   - Technische Details festlegen
   - Offene Fragen beantworten
3. **Claude** liest:
   - `CLAUDE.md` (diese Datei) → Projektregeln
   - `USER-STORY.md` → Aktuelle Feature-Spec
   - `BACKLOG.md` → Kontext & Synergien
4. **Claude** implementiert Feature
   - Aktualisiert Checkboxen in `USER-STORY.md` während Arbeit
   - Hält sich an Code-Standards
   - Führt DoD durch (siehe unten)
5. **User + Claude** besprechen Ergebnis
   - Testing
   - Bugfixing
   - Nachbesserungen
6. **Nächstes Feature:** User erstellt neue `USER-STORY.md`

## Definition of Done (DoD)

**WICHTIG:** Vor jedem Commit müssen folgende Checks durchgeführt werden:

python linting
python tests
vimscript linting
vimscript tests
Wenn Checks fehlschlagen: Iteriere bis alle grün sind!

### Generate mindboxes
Run the generator after changing `journal.txt`:
- `python3 scripts/generate_mindboxes.py` :contentReference[oaicite:3]{index=3}
- Optionally: `python3 scripts/generate_mindboxes.py /path/to/journal.txt --output /path/to/mindboxes` :contentReference[oaicite:4]{index=4}

Mindboxes are considered *generated output*; never edit `mindboxes/*.mb` manually.

### Vim usage (functional expectations)
Once loaded, the plugin should provide:
- `:MindboxList` — list topics in `mindboxes/`
- `:Mindbox <topic>` — open a read-only, help-styled buffer
- `:MindboxSearch <pattern>` — search via `vimgrep` and open quickfix. :contentReference[oaicite:5]{index=5}

---

## Quality standards

### Development standards
- Code und Kommentare im Quellcode **nur in Englisch**
- Git-Commits **nur in Englisch**

### Git Workflow
- Main Branch: main (geschützt)
- Feature Branches: claude/-
- NIEMALS direkt auf main pushen
- Commits: Klare, beschreibende Messages (Englisch)

## Python standards

### Python-Konventionen
- **PEP 8** Style Guide strikt befolgen
- Type Hints wo sinnvoll verwenden
- Docstrings für alle öffentlichen Methoden

### Style / lint
Use **ruff** as the primary tool:
- Formatting: ruff format (or black if preferred, but ruff-only keeps it simpler)
- Lint: ruff (select common rulesets: pyflakes/pycodestyle/isort-equivalent)
- Optional typing: mypy (only if type hints exist and are maintained)

Recommended config in `pyproject.toml`:
- `tool.ruff` + `tool.ruff.format`
- `tool.pytest.ini_options` for pytest defaults

### Testing
Use **pytest**:
- Unit tests for parsing/extraction logic (pure functions)
- File I/O tested via tmp paths (pytest `tmp_path`)
- Snapshot-style tests are acceptable for `.mb` output, but prefer explicit asserts on key sections (timestamps, topic header, line numbers)

Minimum:
- `pytest -q`
- Coverage (optional but recommended): `pytest --cov=scripts --cov-report=term-missing`

### Suggested commands
- `python -m ruff format .`
- `python -m ruff check .`
- `python -m pytest -q`

---

## Vimscript standards
### Style / structure
- Keep `plugin/` minimal (“wiring”: commands, augroups, config defaults)
- Put non-trivial logic into namespaced functions (`autoload/mindbox.vim`) if/when it grows
- All internal helpers should be `s:`-scoped
- No global state except user config `g:mindbox_*`
- Autocmds must live in a dedicated augroup; always `autocmd!` within that augroup

### Lint
Use **vint** (Vimscript linter) where possible.
- Keep lint warnings at zero (or document explicit ignores inline)

### Testing (Option A: built-in Vim assertions)
Use headless Vim to run tests based on `assert_equal()`, `assert_match()`, `assert_true()`, `assert_fails()`.

Recommended test layout:
- `test/run.vim` (test runner)
- `test/test_*.vim` (test files)

Runner responsibilities:
- Add repo root to `runtimepath`
- Source the plugin file
- Execute tests
- Exit non-zero on failure (use `cquit` when `v:errors` is non-empty)

Suggested invocation:
- `vim -Nu NONE -n -es -S test/run.vim`

Test focus:
- `:MindboxList` produces a list buffer with expected topics (use a temporary mindboxes dir)
- `:Mindbox topic` opens expected content and sets buffer read-only/help-ish options
- `:MindboxSearch pattern` populates quickfix with expected hits

Isolation rules for tests:
- Never rely on user vimrc
- Use temp directories and set `g:mindbox_directory` explicitly for the test session
- Clean up buffers/windows created by commands

---

## CI expectations (recommended)
A minimal CI pipeline should run:
1) Python format + lint
2) Python tests
3) Vimscript lint (vint)
4) Vim headless tests

A good default matrix is:
- Python: latest stable (e.g. 3.11/3.12)
- Vim: stable Vim (and optionally Neovim, if you care about compatibility)

---

## When editing code (rules for Claude)
- Prefer small, reviewable diffs.
- Add/adjust tests with every behavioral change.
- Do not change generated `mindboxes/*.mb` manually.
- Keep commands backward compatible unless explicitly bumping a version.
- If introducing new user-facing behavior, update README and (if present) `doc/mindbox.txt`.

## Quick commands (developer cheat sheet)
- Generate: `python3 scripts/generate_mindboxes.py`
- Python: `python -m ruff format . && python -m ruff check . && python -m pytest -q`
- Vim tests: `vim -Nu NONE -n -es -S test/run.vim`

# Kommunikation
- Inhalte und prompts kritsch analysieren.
- Frage stellen sofern unklare Informationen vorliegen
- Fragen mit f1...fn bennen
- In der Kommunikation Präzise und kurz halten, ausser user fragt explizit nach ausführlicher Erklärung oder Antwort nach. style tl;dr
- Vorgehen im Dialog
